<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BudgetSmart - Add Your Store</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:Arial, sans-serif; }
    body { background:#f4f7fa; color:#333; padding:20px; line-height:1.5; }
    .container { max-width:600px; margin:0 auto; background:#fff; border-radius:15px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
    header { background:#007bff; color:#fff; padding:30px 20px; text-align:center; }
    header h1 { font-size:28px; margin-bottom:8px; }
    .tabs { display:flex; background:#f0f0f0; }
    .tab { flex:1; padding:15px; text-align:center; cursor:pointer; font-weight:bold; transition:0.3s; }
    .tab.active { background:#007bff; color:#fff; }
    .tab-content { padding:30px; display:none; }
    .tab-content.active { display:block; }
    input, button { width:100%; padding:14px; margin:10px 0; border-radius:8px; border:1px solid #ccc; font-size:16px; }
    input:focus { outline:none; border-color:#007bff; }
    button { background:#007bff; color:#fff; border:none; cursor:pointer; font-weight:bold; }
    button:hover { background:#0056b3; }
    .success { margin-top:15px; font-size:18px; text-align:center; min-height:30px; font-weight:bold; }
    .debug-btn { background:#28a745; margin-top:20px; }
    .debug-btn:hover { background:#1e7e34; }
    #debugList { margin-top:15px; background:#f8f9fa; padding:15px; border-radius:8px; max-height:300px; overflow-y:auto; font-size:14px; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>BudgetSmart Nigeria</h1>
    <p>Add your store — reach thousands of smart buyers!</p>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="openTab('website')">Add via Website</div>
    <div class="tab" onclick="openTab('manual')">Add via Image + Price</div>
  </div>

  <!-- TAB 1: Connect Website -->
  <div id="website" class="tab-content active">
    <h2>Connect Your Online Store</h2>
    <p>We’ll automatically add your products in the background</p>
    <form id="websiteForm">
      <input type="text" name="sellerName" id="sellerName" placeholder="Your Store Name (e.g. M-Chris Phones)" required />
      <input type="text" name="website" id="websiteInput" placeholder="mchris.ng or https://yourstore.com" required />
      <button type="submit">Connect Store</button>
    </form>
    <p id="msg1" class="success"></p>
  </div>

  <!-- TAB 2: Manual Upload -->
  <div id="manual" class="tab-content">
    <h2>Add Item Manually</h2>
    <p>Upload photo + price instantly</p>
    <form id="manualForm" enctype="multipart/form-data">
      <input type="text" name="sellerName" placeholder="Your Store Name" required />
      <input type="text" name="itemName" placeholder="Item Name (e.g. iPhone 15 Pro)" required />
      <input type="number" name="itemPrice" placeholder="Price in ₦ (e.g. 850000)" required />
      <input type="file" name="image" accept="image/*" required />
      <button type="submit">Add Item Now</button>
    </form>
    <p id="msg2" class="success"></p>
  </div>

  <!-- Check Added Products -->
  <div style="padding:20px; text-align:center;">
    <button class="debug-btn" onclick="checkProducts()">Check My Added Products</button>
    <div id="debugList"></div>
  </div>
</div>

<script>
function openTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');
}

function showMsg(id, text, color = 'green') {
  const el = document.getElementById(id);
  el.innerHTML = `<span style="color:${color}">${text}</span>`;
  if (color === 'green') setTimeout(() => el.textContent = '', 8000);
}

// Website Form
document.getElementById('websiteForm').onsubmit = async e => {
  e.preventDefault();
  showMsg('msg1', 'Connecting...', 'blue');

  const sellerName = document.getElementById('sellerName').value.trim();
  let website = document.getElementById('websiteInput').value.trim();

  if (!sellerName || !website) return showMsg('msg1', 'Fill both fields', 'red');
  if (!website.includes('.')) return showMsg('msg1', 'Enter valid website (e.g. mchris.ng)', 'red');

  website = website.toLowerCase().replace(/^https?:\/\//i, '').replace(/^www\./i, '').trim();
  website = 'https://' + website.replace(/\/+$/, '');

  const fd = new FormData();
  fd.append('sellerName', sellerName);
  fd.append('website', website);
  fd.append('type', 'website');

  try {
    const res = await fetch('/api/seller', { method: 'POST', body: fd });
    const json = await res.json();
    showMsg('msg1', json.success ? json.message : json.error || 'Failed', json.success ? 'green' : 'red');
    if (json.success) e.target.reset();
  } catch (err) {
    showMsg('msg1', 'No internet — try again', 'red');
  }
};

// Manual Form
document.getElementById('manualForm').onsubmit = async e => {
  e.preventDefault();
  showMsg('msg2', 'Uploading...', 'blue');

  const fd = new FormData(e.target);
  fd.append('type', 'manual');

  try {
    const res = await fetch('/api/seller', { method: 'POST', body: fd });
    const json = await res.json();
    showMsg('msg2', json.success ? 'Item added instantly!' : json.error || 'Failed', json.success ? 'green' : 'red');
    if (json.success) e.target.reset();
  } catch (err) {
    showMsg('msg2', 'Upload failed — check connection', 'red');
  }
};

// Check products in DB
async function checkProducts() {
  const input = prompt("Enter store name or website (e.g. mchris.ng):");
  if (!input) return;

  document.getElementById('debugList').innerHTML = 'Loading...';
  try {
    const res = await fetch(`/api/debug?q=${encodeURIComponent(input.trim())}`);
    const items = await res.json();
    if (items.length === 0) {
      document.getElementById('debugList').innerHTML = '<span style="color:orange;">No products yet. Wait 1–2 minutes after connecting.</span>';
    } else {
      const list = items.map(i => `• ${i.name} — ₦${Number(i.price).toLocaleString()}`).join('<br>');
      document.getElementById('debugList').innerHTML = `<span style="color:green;">Found ${items.length} products!</span><br>${list}`;
    }
  } catch (err) {
    document.getElementById('debugList').innerHTML = '<span style="color:red;">Error</span>';
  }
}
</script>

</body>
</html>
